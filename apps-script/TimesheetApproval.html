<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-approved { background-color: #28a745; }
        .badge-rejected { background-color: #dc3545; }
        .editable-cell {
            padding: 5px;
            border: 1px solid transparent;
            border-radius: 3px;
        }
        .editable-cell:focus {
            border-color: #007bff;
            outline: none;
        }
        .inline-edit {
            width: 50px;
            padding: 2px 4px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            text-align: right;
            font-size: 0.875rem;
        }
        .inline-edit:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .inline-edit.modified {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        .save-row-btn {
            padding: 2px 6px;
            font-size: 0.75rem;
        }
        .action-buttons { display: flex; gap: 5px; }
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-overlay.show {
            display: flex;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-clock"></i> Pending Timesheets</h5>
            <div>
                <button class="btn btn-success btn-sm" onclick="loadModule('timesheetImport')">
                    <i class="fas fa-file-upload"></i> Import New Timesheets
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Filter Section -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-4">
                        <select class="form-select" id="filterStatus" onchange="filterTimesheets()">
                            <option value="Pending">Pending Only</option>
                            <option value="">All Statuses</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchEmployee"
                               placeholder="Search by employee..." onkeyup="filterTimesheets()">
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="filterWeekEnding"
                               placeholder="Week ending" onchange="filterTimesheets()">
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <div class="mb-2">
                    <button class="btn btn-primary btn-sm" onclick="saveAllModified()" id="saveAllBtn" style="display:none;">
                        <i class="fas fa-save"></i> Save All Changes (<span id="modifiedCount">0</span>)
                    </button>
                    <button class="btn btn-success btn-sm" onclick="bulkApprove()" id="bulkApproveBtn" style="display:none;">
                        <i class="fas fa-check-double"></i> Approve Selected (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="selectAll()" id="selectAllBtn">
                        <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="deselectAll()" id="deselectAllBtn" style="display:none;">
                        <i class="fas fa-square"></i> Deselect All
                    </button>
                </div>
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"></th>
                            <th>Employee</th>
                            <th>Clock Ref</th>
                            <th>Week Ending</th>
                            <th>Calc Hours</th>
                            <th>Calc Mins</th>
                            <th>Hours</th>
                            <th>Mins</th>
                            <th>OT Hours</th>
                            <th>OT Mins</th>
                            <th>Bathroom (min)</th>
                            <th>Warnings</th>
                            <th>Status</th>
                            <th>Import Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="timesheetsTableBody">
                        <tr><td colspan="15" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Timesheet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTimesheetId">

                    <div class="mb-3">
                        <label class="form-label">Employee</label>
                        <input type="text" class="form-control" id="editEmployee" readonly>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Hours</label>
                                <input type="number" class="form-control" id="editHours" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Minutes</label>
                                <input type="number" class="form-control" id="editMinutes" min="0" max="59">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">OT Hours</label>
                                <input type="number" class="form-control" id="editOTHours" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">OT Minutes</label>
                                <input type="number" class="form-control" id="editOTMinutes" min="0" max="59">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Incomplete Week Modal -->
    <div class="modal fade" id="incompleteWeekModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Incomplete Week Detected</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="incompleteTimesheetId">

                    <div class="alert alert-warning mb-3">
                        <strong><span id="incompleteEmployeeName"></span></strong> did not work a full week.
                        <br>Week ending: <strong><span id="incompleteWeekEnding"></span></strong>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Missing Clock-In Days:</strong></label>
                        <div id="missingDaysList" class="list-group">
                            <!-- Missing days will be populated here -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Add these days to leave system?</strong></label>
                        <select class="form-select" id="leaveReason">
                            <option value="">-- Select Leave Reason --</option>
                            <option value="AWOL">AWOL (Absent Without Leave)</option>
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="Annual Leave">Annual Leave</option>
                            <option value="Unpaid Leave">Unpaid Leave</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="leaveNotes" rows="2" placeholder="Additional notes for leave records..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="approveWithoutLeave()">
                        Approve Without Adding Leave
                    </button>
                    <button type="button" class="btn btn-primary" onclick="approveWithLeave()">
                        Add to Leave & Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var allTimesheets = [];
        var editModal;

        function loadTimesheets() {
            showLoading();

            const filters = {
                status: document.getElementById('filterStatus').value || undefined
            };

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        allTimesheets = result.data;
                        filterTimesheets();
                    } else {
                        showError('Failed to load timesheets: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .listPendingTimesheets(filters);
        }

        function displayTimesheets(timesheets) {
            const tbody = document.getElementById('timesheetsTableBody');

            if (timesheets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="text-center">No timesheets found</td></tr>';
                return;
            }

            tbody.innerHTML = timesheets.map(ts => {
                const statusClass = ts.STATUS === 'Pending' ? 'badge-pending' :
                                   ts.STATUS === 'Approved' ? 'badge-approved' : 'badge-rejected';

                const isPending = ts.STATUS === 'Pending';

                // Parse warnings if JSON string
                let warningCount = 0;
                let warningText = '';
                try {
                    if (ts.WARNINGS) {
                        const warnings = typeof ts.WARNINGS === 'string' ? JSON.parse(ts.WARNINGS) : ts.WARNINGS;
                        if (Array.isArray(warnings)) {
                            warningCount = warnings.length;
                            warningText = warnings.join('; ');
                        }
                    }
                } catch (e) {
                    warningText = ts.WARNINGS || '';
                }

                const warningBadge = warningCount > 0
                    ? `<span class="badge bg-warning text-dark" title="${escapeHtml(warningText)}">${warningCount}</span>`
                    : '-';

                // Get week ending - try multiple field names
                const weekEndingValue = ts.WEEKENDING || ts.WEEK_ENDING || ts['WEEK ENDING'] || '';

                return `
                    <tr data-id="${ts.ID}">
                        <td>
                            ${isPending ? `
                                <input type="checkbox" class="row-checkbox" data-id="${ts.ID}" onchange="updateBulkSelection()">
                            ` : ''}
                        </td>
                        <td><strong>${escapeHtml(ts['EMPLOYEE NAME'] || '')}</strong></td>
                        <td>${escapeHtml(ts.EMPLOYEE_CLOCK_REF || '-')}</td>
                        <td>${formatDate(weekEndingValue)}</td>
                        <td class="text-end">${ts.CALCULATED_TOTAL_HOURS || 0}</td>
                        <td class="text-end">${ts.CALCULATED_TOTAL_MINUTES || 0}</td>
                        <td>
                            ${isPending ? `
                                <input type="number" class="inline-edit" id="hours-${ts.ID}"
                                       value="${ts.HOURS || 0}" min="0"
                                       onchange="markModified(this, '${ts.ID}')"
                                       data-original="${ts.HOURS || 0}">
                            ` : `<span class="text-end">${ts.HOURS || 0}</span>`}
                        </td>
                        <td>
                            ${isPending ? `
                                <input type="number" class="inline-edit" id="mins-${ts.ID}"
                                       value="${ts.MINUTES || 0}" min="0" max="59"
                                       onchange="markModified(this, '${ts.ID}')"
                                       data-original="${ts.MINUTES || 0}">
                            ` : `<span class="text-end">${ts.MINUTES || 0}</span>`}
                        </td>
                        <td>
                            ${isPending ? `
                                <input type="number" class="inline-edit" id="ot-hours-${ts.ID}"
                                       value="${ts.OVERTIMEHOURS || 0}" min="0"
                                       onchange="markModified(this, '${ts.ID}')"
                                       data-original="${ts.OVERTIMEHOURS || 0}">
                            ` : `<span class="text-end">${ts.OVERTIMEHOURS || 0}</span>`}
                        </td>
                        <td>
                            ${isPending ? `
                                <input type="number" class="inline-edit" id="ot-mins-${ts.ID}"
                                       value="${ts.OVERTIMEMINUTES || 0}" min="0" max="59"
                                       onchange="markModified(this, '${ts.ID}')"
                                       data-original="${ts.OVERTIMEMINUTES || 0}">
                            ` : `<span class="text-end">${ts.OVERTIMEMINUTES || 0}</span>`}
                        </td>
                        <td class="text-end">${ts.BATHROOM_TIME_MIN || 0}</td>
                        <td>${warningBadge}</td>
                        <td><span class="badge ${statusClass}">${ts.STATUS}</span></td>
                        <td><small>${formatDate(ts.IMPORTED_DATE)}</small></td>
                        <td class="action-buttons">
                            ${isPending ? `
                                <button class="btn btn-sm btn-primary save-row-btn" id="save-btn-${ts.ID}"
                                        onclick="saveInlineEdit('${ts.ID}')" title="Save" style="display:none;">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="approveTimesheet('${ts.ID}')" title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="rejectTimesheet('${ts.ID}')" title="Reject">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterTimesheets() {
            const searchText = document.getElementById('searchEmployee').value.toLowerCase();
            const weekEnding = document.getElementById('filterWeekEnding').value;

            let filtered = allTimesheets.filter(ts => {
                const matchesSearch = !searchText ||
                    (ts['EMPLOYEE NAME'] && ts['EMPLOYEE NAME'].toLowerCase().includes(searchText));

                let matchesDate = true;
                if (weekEnding) {
                    try {
                        // Parse both dates to compare just the date part (ignore time)
                        const tsDate = new Date(ts.WEEKENDING);
                        const filterDate = new Date(weekEnding);

                        // Compare dates only (YYYY-MM-DD)
                        const tsDateStr = formatDate(tsDate);
                        const filterDateStr = formatDate(filterDate);

                        matchesDate = tsDateStr === filterDateStr;
                    } catch (e) {
                        console.error('Date filter error:', e);
                        matchesDate = false;
                    }
                }

                return matchesSearch && matchesDate;
            });

            displayTimesheets(filtered);
        }

        function editTimesheet(timesheetId) {
            const timesheet = allTimesheets.find(ts => ts.ID === timesheetId);
            if (!timesheet) return;

            document.getElementById('editTimesheetId').value = timesheetId;
            document.getElementById('editEmployee').value = timesheet['EMPLOYEE NAME'];
            document.getElementById('editHours').value = timesheet.HOURS || 0;
            document.getElementById('editMinutes').value = timesheet.MINUTES || 0;
            document.getElementById('editOTHours').value = timesheet.OVERTIMEHOURS || 0;
            document.getElementById('editOTMinutes').value = timesheet.OVERTIMEMINUTES || 0;
            document.getElementById('editNotes').value = timesheet.NOTES || '';

            if (!editModal) {
                editModal = new bootstrap.Modal(document.getElementById('editModal'));
            }
            editModal.show();
        }

        function saveEdit() {
            showLoading();

            const timesheetId = document.getElementById('editTimesheetId').value;
            const data = {
                hours: parseInt(document.getElementById('editHours').value),
                minutes: parseInt(document.getElementById('editMinutes').value),
                overtimeHours: parseInt(document.getElementById('editOTHours').value),
                overtimeMinutes: parseInt(document.getElementById('editOTMinutes').value),
                notes: document.getElementById('editNotes').value
            };

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        showSuccess('Timesheet updated successfully');
                        editModal.hide();
                        loadTimesheets();
                    } else {
                        showError(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .updatePendingTimesheet(timesheetId, data);
        }

        var incompleteWeekModal;
        var currentIncompleteCheck = null; // Store incomplete week check data

        function approveTimesheet(timesheetId) {
            console.log('Approving timesheet:', timesheetId);
            showLoading();

            // First, check if the week is incomplete
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Check result:', result);
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        console.log('Is incomplete:', result.data.isIncomplete);
                        console.log('Missing days:', result.data.missingDays);
                        if (result.data.isIncomplete) {
                            // Week is incomplete - show modal
                            showIncompleteWeekModal(result.data);
                        } else {
                            // Week is complete - proceed with normal approval
                            proceedWithApproval(timesheetId);
                        }
                    } else {
                        showError(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error checking timesheet:', error);
                    hideLoading();
                    showError('Error checking timesheet: ' + error.message);
                })
                .checkTimesheetBeforeApproval(timesheetId);
        }

        function showIncompleteWeekModal(incompleteData) {
            currentIncompleteCheck = incompleteData;

            // Populate modal fields
            document.getElementById('incompleteTimesheetId').value = incompleteData.timesheetId;
            document.getElementById('incompleteEmployeeName').textContent = incompleteData.employeeName;
            document.getElementById('incompleteWeekEnding').textContent = formatDate(incompleteData.weekEnding);

            // Build missing days list
            const missingDaysList = document.getElementById('missingDaysList');
            missingDaysList.innerHTML = incompleteData.missingDays.map(day => {
                return `
                    <div class="list-group-item">
                        <i class="fas fa-calendar-times text-danger"></i>
                        <strong>${day.dayName}</strong> - ${formatDate(day.dateString)}
                    </div>
                `;
            }).join('');

            // Reset form fields
            document.getElementById('leaveReason').value = '';
            document.getElementById('leaveNotes').value = '';

            // Show modal
            if (!incompleteWeekModal) {
                incompleteWeekModal = new bootstrap.Modal(document.getElementById('incompleteWeekModal'));
            }
            incompleteWeekModal.show();
        }

        function approveWithLeave() {
            const timesheetId = document.getElementById('incompleteTimesheetId').value;
            const leaveReason = document.getElementById('leaveReason').value;
            const leaveNotes = document.getElementById('leaveNotes').value;

            if (!leaveReason) {
                showError('Please select a leave reason');
                return;
            }

            if (!currentIncompleteCheck || !currentIncompleteCheck.missingDays) {
                showError('Missing days data not found');
                return;
            }

            incompleteWeekModal.hide();
            showLoading();

            // Call backend to approve and create leave records
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        const msg = `Timesheet approved! Payslip #${result.data.payslipRecordNumber} created. ` +
                                    `${result.data.leaveRecordsCreated} leave record(s) added.`;
                        showSuccess(msg);
                        loadTimesheets();
                        currentIncompleteCheck = null;
                    } else {
                        showError(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .approveTimesheetWithLeave(timesheetId, currentIncompleteCheck.missingDays, leaveReason, leaveNotes);
        }

        function approveWithoutLeave() {
            const timesheetId = document.getElementById('incompleteTimesheetId').value;

            if (!confirm('Approve without adding missing days to leave system?')) {
                return;
            }

            incompleteWeekModal.hide();
            proceedWithApproval(timesheetId);
        }

        function proceedWithApproval(timesheetId) {
            if (!confirm('Approve this timesheet? This will create a payslip.')) return;

            showLoading();

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        showSuccess('Timesheet approved! Payslip #' + result.data.payslipRecordNumber + ' created.');
                        loadTimesheets();
                    } else {
                        showError(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .approveTimesheet(timesheetId);
        }

        function rejectTimesheet(timesheetId) {
            const reason = prompt('Enter rejection reason (optional):');
            if (reason === null) return; // User cancelled

            showLoading();

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        showSuccess('Timesheet rejected');
                        loadTimesheets();
                    } else {
                        showError(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .rejectTimesheet(timesheetId, reason);
        }

        // Track which rows have been modified
        var modifiedRows = {};

        function markModified(input, timesheetId) {
            const originalValue = input.getAttribute('data-original');
            const currentValue = input.value;

            if (currentValue !== originalValue) {
                input.classList.add('modified');
                modifiedRows[timesheetId] = true;
            } else {
                input.classList.remove('modified');
                // Check if any other inputs in this row are modified
                const row = input.closest('tr');
                const inputs = row.querySelectorAll('.inline-edit');
                let hasModified = false;
                inputs.forEach(inp => {
                    if (inp.value !== inp.getAttribute('data-original')) {
                        hasModified = true;
                    }
                });
                modifiedRows[timesheetId] = hasModified;
            }

            // Show/hide save button
            const saveBtn = document.getElementById('save-btn-' + timesheetId);
            if (saveBtn) {
                saveBtn.style.display = modifiedRows[timesheetId] ? 'inline-block' : 'none';
            }

            // Update Save All button
            updateSaveAllButton();
        }

        function updateSaveAllButton() {
            const modifiedCount = Object.values(modifiedRows).filter(v => v === true).length;
            document.getElementById('modifiedCount').textContent = modifiedCount;
            document.getElementById('saveAllBtn').style.display = modifiedCount > 0 ? 'inline-block' : 'none';
        }

        function hasUnsavedChanges() {
            return Object.values(modifiedRows).some(v => v === true);
        }

        function saveInlineEdit(timesheetId) {
            const hours = document.getElementById('hours-' + timesheetId);
            const mins = document.getElementById('mins-' + timesheetId);
            const otHours = document.getElementById('ot-hours-' + timesheetId);
            const otMins = document.getElementById('ot-mins-' + timesheetId);

            if (!hours || !mins || !otHours || !otMins) {
                showError('Could not find input fields');
                return;
            }

            showLoading();

            const data = {
                hours: parseInt(hours.value) || 0,
                minutes: parseInt(mins.value) || 0,
                overtimeHours: parseInt(otHours.value) || 0,
                overtimeMinutes: parseInt(otMins.value) || 0,
                notes: '' // No notes field in inline edit
            };

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        showSuccess('Timesheet updated successfully');

                        // Update original values and remove modified styling
                        hours.setAttribute('data-original', hours.value);
                        mins.setAttribute('data-original', mins.value);
                        otHours.setAttribute('data-original', otHours.value);
                        otMins.setAttribute('data-original', otMins.value);

                        hours.classList.remove('modified');
                        mins.classList.remove('modified');
                        otHours.classList.remove('modified');
                        otMins.classList.remove('modified');

                        // Hide save button
                        const saveBtn = document.getElementById('save-btn-' + timesheetId);
                        if (saveBtn) {
                            saveBtn.style.display = 'none';
                        }

                        modifiedRows[timesheetId] = false;

                        // Update local data
                        const ts = allTimesheets.find(t => t.ID === timesheetId);
                        if (ts) {
                            ts.HOURS = data.hours;
                            ts.MINUTES = data.minutes;
                            ts.OVERTIMEHOURS = data.overtimeHours;
                            ts.OVERTIMEMINUTES = data.overtimeMinutes;
                        }

                        // Update Save All button
                        updateSaveAllButton();
                    } else {
                        showError(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .updatePendingTimesheet(timesheetId, data);
        }

        function saveAllModified() {
            const modifiedIds = Object.keys(modifiedRows).filter(id => modifiedRows[id] === true);

            if (modifiedIds.length === 0) {
                showWarning('No changes to save');
                return;
            }

            if (!confirm(`Save changes to ${modifiedIds.length} timesheet(s)?`)) {
                return;
            }

            showLoading();

            let saved = 0;
            let failed = 0;
            let current = 0;

            function saveNext() {
                if (current >= modifiedIds.length) {
                    hideLoading();
                    if (failed === 0) {
                        showSuccess(`Successfully saved ${saved} timesheet(s)`);
                    } else {
                        showWarning(`Saved ${saved}, failed ${failed}`);
                    }
                    // Update Save All button after all saves are complete
                    updateSaveAllButton();
                    return;
                }

                const timesheetId = modifiedIds[current];
                current++;

                const hours = document.getElementById('hours-' + timesheetId);
                const mins = document.getElementById('mins-' + timesheetId);
                const otHours = document.getElementById('ot-hours-' + timesheetId);
                const otMins = document.getElementById('ot-mins-' + timesheetId);

                if (!hours || !mins || !otHours || !otMins) {
                    failed++;
                    saveNext();
                    return;
                }

                const data = {
                    hours: parseInt(hours.value) || 0,
                    minutes: parseInt(mins.value) || 0,
                    overtimeHours: parseInt(otHours.value) || 0,
                    overtimeMinutes: parseInt(otMins.value) || 0,
                    notes: ''
                };

                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success) {
                            saved++;

                            // Update original values and remove modified styling
                            hours.setAttribute('data-original', hours.value);
                            mins.setAttribute('data-original', mins.value);
                            otHours.setAttribute('data-original', otHours.value);
                            otMins.setAttribute('data-original', otMins.value);

                            hours.classList.remove('modified');
                            mins.classList.remove('modified');
                            otHours.classList.remove('modified');
                            otMins.classList.remove('modified');

                            // Hide save button
                            const saveBtn = document.getElementById('save-btn-' + timesheetId);
                            if (saveBtn) {
                                saveBtn.style.display = 'none';
                            }

                            modifiedRows[timesheetId] = false;

                            // Update local data
                            const ts = allTimesheets.find(t => t.ID === timesheetId);
                            if (ts) {
                                ts.HOURS = data.hours;
                                ts.MINUTES = data.minutes;
                                ts.OVERTIMEHOURS = data.overtimeHours;
                                ts.OVERTIMEMINUTES = data.overtimeMinutes;
                            }
                        } else {
                            failed++;
                        }
                        saveNext();
                    })
                    .withFailureHandler(function(error) {
                        failed++;
                        saveNext();
                    })
                    .updatePendingTimesheet(timesheetId, data);
            }

            saveNext();
        }

        // ==================== BULK SELECTION ====================

        function updateBulkSelection() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const count = checkboxes.length;

            document.getElementById('selectedCount').textContent = count;
            document.getElementById('bulkApproveBtn').style.display = count > 0 ? 'inline-block' : 'none';
            document.getElementById('deselectAllBtn').style.display = count > 0 ? 'inline-block' : 'none';

            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
                selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
            }
        }

        function toggleSelectAll(checkbox) {
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            allCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBulkSelection();
        }

        function selectAll() {
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            allCheckboxes.forEach(cb => {
                cb.checked = true;
            });
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = true;
            updateBulkSelection();
        }

        function deselectAll() {
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            allCheckboxes.forEach(cb => {
                cb.checked = false;
            });
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateBulkSelection();
        }

        function bulkApprove() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));

            if (ids.length === 0) {
                showWarning('No timesheets selected');
                return;
            }

            if (!confirm(`Approve ${ids.length} timesheet(s)? This will create payslips for each.`)) {
                return;
            }

            showLoading();

            // Process approvals sequentially
            let approved = 0;
            let failed = 0;
            let current = 0;

            function approveNext() {
                if (current >= ids.length) {
                    hideLoading();
                    if (failed === 0) {
                        showSuccess(`Successfully approved ${approved} timesheet(s)`);
                    } else {
                        showWarning(`Approved ${approved}, failed ${failed}`);
                    }
                    loadTimesheets();
                    return;
                }

                const timesheetId = ids[current];
                current++;

                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success) {
                            approved++;
                        } else {
                            failed++;
                        }
                        approveNext();
                    })
                    .withFailureHandler(function(error) {
                        failed++;
                        approveNext();
                    })
                    .approveTimesheet(timesheetId);
            }

            approveNext();
        }

        // ==================== UTILITY FUNCTIONS ====================

        /**
         * Format date for display
         * Handles Date objects, date strings, and invalid dates
         */
        function formatDate(dateValue) {
            if (!dateValue) return '-';

            try {
                let date;
                if (dateValue instanceof Date) {
                    date = dateValue;
                } else if (typeof dateValue === 'string' || typeof dateValue === 'number') {
                    date = new Date(dateValue);
                } else {
                    return '-';
                }

                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return '-';
                }

                // Format as YYYY-MM-DD
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');

                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error('Date formatting error:', e, dateValue);
                return '-';
            }
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        /**
         * Format time duration
         */
        function formatDuration(hours, minutes) {
            const h = parseInt(hours) || 0;
            const m = parseInt(minutes) || 0;
            return h + 'h ' + m + 'm';
        }

        // Load timesheets on page load
        document.getElementById('filterStatus').value = 'Pending'; // Default to pending only
        loadTimesheets();

        // Expose unsaved changes check globally for navigation interception
        window.checkUnsavedChanges = hasUnsavedChanges;

        // Warn user before closing/refreshing if there are unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        // Clean up global function when this module is unloaded
        window.addEventListener('unload', function() {
            delete window.checkUnsavedChanges;
        });

        // ==================== UTILITY FUNCTIONS ====================
        // These functions allow the module to work standalone (e.g., in OAuth dialogs)

        function showLoading() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'danger');
        }

        function showWarning(message) {
            showToast(message, 'warning');
        }

        function showInfo(message) {
            showToast(message, 'info');
        }

        function showToast(message, type) {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                // Fallback to alert if toast container not found
                alert(message);
                console.error('Toast container not found');
                return;
            }

            const toastId = 'toast-' + Date.now();

            const toastHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            const toastElement = document.getElementById(toastId);
            if (toastElement && typeof bootstrap !== 'undefined') {
                const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
                toast.show();

                toastElement.addEventListener('hidden.bs.toast', function() {
                    toastElement.remove();
                });
            } else {
                // Fallback for environments without Bootstrap
                setTimeout(function() {
                    if (toastElement) {
                        toastElement.remove();
                    }
                }, 5000);
            }
        }
    </script>
</body>
</html>
