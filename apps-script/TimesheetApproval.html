<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-approved { background-color: #28a745; }
        .badge-rejected { background-color: #dc3545; }
        .editable-cell {
            padding: 5px;
            border: 1px solid transparent;
            border-radius: 3px;
        }
        .editable-cell:focus {
            border-color: #007bff;
            outline: none;
        }
        .action-buttons { display: flex; gap: 5px; }
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-overlay.show {
            display: flex;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-clock"></i> Pending Timesheets</h5>
            <div>
                <button class="btn btn-success btn-sm" onclick="loadModule('timesheetImport')">
                    <i class="fas fa-file-upload"></i> Import New Timesheets
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Filter Section -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-4">
                        <select class="form-select" id="filterStatus" onchange="filterTimesheets()">
                            <option value="Pending">Pending Only</option>
                            <option value="">All Statuses</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchEmployee"
                               placeholder="Search by employee..." onkeyup="filterTimesheets()">
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="filterWeekEnding"
                               placeholder="Week ending" onchange="filterTimesheets()">
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Employee</th>
                            <th>Clock Ref</th>
                            <th>Week Ending</th>
                            <th>Calc Hours</th>
                            <th>Calc Mins</th>
                            <th>Hours</th>
                            <th>Mins</th>
                            <th>OT Hours</th>
                            <th>OT Mins</th>
                            <th>Lunch (min)</th>
                            <th>Bathroom (min)</th>
                            <th>Warnings</th>
                            <th>Status</th>
                            <th>Import Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="timesheetsTableBody">
                        <tr><td colspan="15" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Timesheet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTimesheetId">

                    <div class="mb-3">
                        <label class="form-label">Employee</label>
                        <input type="text" class="form-control" id="editEmployee" readonly>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Hours</label>
                                <input type="number" class="form-control" id="editHours" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Minutes</label>
                                <input type="number" class="form-control" id="editMinutes" min="0" max="59">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">OT Hours</label>
                                <input type="number" class="form-control" id="editOTHours" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">OT Minutes</label>
                                <input type="number" class="form-control" id="editOTMinutes" min="0" max="59">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var allTimesheets = [];
        var editModal;

        function loadTimesheets() {
            showLoading();

            const filters = {
                status: document.getElementById('filterStatus').value || undefined
            };

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        allTimesheets = result.data;
                        filterTimesheets();
                    } else {
                        showError('Failed to load timesheets: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .listPendingTimesheets(filters);
        }

        function displayTimesheets(timesheets) {
            const tbody = document.getElementById('timesheetsTableBody');

            if (timesheets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="text-center">No timesheets found</td></tr>';
                return;
            }

            tbody.innerHTML = timesheets.map(ts => {
                const statusClass = ts.STATUS === 'Pending' ? 'badge-pending' :
                                   ts.STATUS === 'Approved' ? 'badge-approved' : 'badge-rejected';

                const isPending = ts.STATUS === 'Pending';

                // Parse warnings if JSON string
                let warningCount = 0;
                let warningText = '';
                try {
                    if (ts.WARNINGS) {
                        const warnings = typeof ts.WARNINGS === 'string' ? JSON.parse(ts.WARNINGS) : ts.WARNINGS;
                        if (Array.isArray(warnings)) {
                            warningCount = warnings.length;
                            warningText = warnings.join('; ');
                        }
                    }
                } catch (e) {
                    warningText = ts.WARNINGS || '';
                }

                const warningBadge = warningCount > 0
                    ? `<span class="badge bg-warning text-dark" title="${escapeHtml(warningText)}">${warningCount}</span>`
                    : '-';

                return `
                    <tr>
                        <td><strong>${escapeHtml(ts.EMPLOYEE_NAME || '')}</strong></td>
                        <td>${escapeHtml(ts.EMPLOYEE_CLOCK_REF || '-')}</td>
                        <td>${formatDate(ts.WEEK_ENDING)}</td>
                        <td class="text-end">${ts.CALCULATED_TOTAL_HOURS || 0}</td>
                        <td class="text-end">${ts.CALCULATED_TOTAL_MINUTES || 0}</td>
                        <td class="text-end">${ts.STANDARD_HOURS || 0}</td>
                        <td class="text-end">${ts.STANDARD_MINUTES || 0}</td>
                        <td class="text-end">${ts.OVERTIME_HOURS || 0}</td>
                        <td class="text-end">${ts.OVERTIME_MINUTES || 0}</td>
                        <td class="text-end">${ts.LUNCH_DEDUCTION_MIN || 0}</td>
                        <td class="text-end">${ts.BATHROOM_TIME_MIN || 0}</td>
                        <td>${warningBadge}</td>
                        <td><span class="badge ${statusClass}">${ts.STATUS}</span></td>
                        <td><small>${formatDate(ts.CREATED_DATE)}</small></td>
                        <td class="action-buttons">
                            ${isPending ? `
                                <button class="btn btn-sm btn-info" onclick="editTimesheet('${ts.ID}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="approveTimesheet('${ts.ID}')" title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="rejectTimesheet('${ts.ID}')" title="Reject">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterTimesheets() {
            const searchText = document.getElementById('searchEmployee').value.toLowerCase();
            const weekEnding = document.getElementById('filterWeekEnding').value;

            let filtered = allTimesheets.filter(ts => {
                const matchesSearch = !searchText ||
                    (ts.EMPLOYEE_NAME && ts.EMPLOYEE_NAME.toLowerCase().includes(searchText));

                let matchesDate = true;
                if (weekEnding) {
                    try {
                        // Parse both dates to compare just the date part (ignore time)
                        const tsDate = new Date(ts.WEEK_ENDING);
                        const filterDate = new Date(weekEnding);

                        // Compare dates only (YYYY-MM-DD)
                        const tsDateStr = formatDate(tsDate);
                        const filterDateStr = formatDate(filterDate);

                        matchesDate = tsDateStr === filterDateStr;
                    } catch (e) {
                        console.error('Date filter error:', e);
                        matchesDate = false;
                    }
                }

                return matchesSearch && matchesDate;
            });

            displayTimesheets(filtered);
        }

        function editTimesheet(timesheetId) {
            const timesheet = allTimesheets.find(ts => ts.ID === timesheetId);
            if (!timesheet) return;

            document.getElementById('editTimesheetId').value = timesheetId;
            document.getElementById('editEmployee').value = timesheet.EMPLOYEE_NAME;
            document.getElementById('editHours').value = timesheet.STANDARD_HOURS || 0;
            document.getElementById('editMinutes').value = timesheet.STANDARD_MINUTES || 0;
            document.getElementById('editOTHours').value = timesheet.OVERTIME_HOURS || 0;
            document.getElementById('editOTMinutes').value = timesheet.OVERTIME_MINUTES || 0;
            document.getElementById('editNotes').value = timesheet.NOTES || '';

            if (!editModal) {
                editModal = new bootstrap.Modal(document.getElementById('editModal'));
            }
            editModal.show();
        }

        function saveEdit() {
            showLoading();

            const timesheetId = document.getElementById('editTimesheetId').value;
            const data = {
                hours: parseInt(document.getElementById('editHours').value),
                minutes: parseInt(document.getElementById('editMinutes').value),
                overtimeHours: parseInt(document.getElementById('editOTHours').value),
                overtimeMinutes: parseInt(document.getElementById('editOTMinutes').value),
                notes: document.getElementById('editNotes').value
            };

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        showSuccess('Timesheet updated successfully');
                        editModal.hide();
                        loadTimesheets();
                    } else {
                        showError(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .updatePendingTimesheet(timesheetId, data);
        }

        function approveTimesheet(timesheetId) {
            if (!confirm('Approve this timesheet? This will create a payslip.')) return;

            showLoading();

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        showSuccess('Timesheet approved! Payslip #' + result.data.payslipRecordNumber + ' created.');
                        loadTimesheets();
                    } else {
                        showError(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .approveTimesheet(timesheetId);
        }

        function rejectTimesheet(timesheetId) {
            const reason = prompt('Enter rejection reason (optional):');
            if (reason === null) return; // User cancelled

            showLoading();

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (!result) {
                        showError('Authorization required or server returned no response. Please try again.');
                        return;
                    }
                    if (result.success) {
                        showSuccess('Timesheet rejected');
                        loadTimesheets();
                    } else {
                        showError(result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('Error: ' + error.message);
                })
                .rejectTimesheet(timesheetId, reason);
        }

        // ==================== UTILITY FUNCTIONS ====================

        /**
         * Format date for display
         * Handles Date objects, date strings, and invalid dates
         */
        function formatDate(dateValue) {
            if (!dateValue) return '-';

            try {
                let date;
                if (dateValue instanceof Date) {
                    date = dateValue;
                } else if (typeof dateValue === 'string' || typeof dateValue === 'number') {
                    date = new Date(dateValue);
                } else {
                    return '-';
                }

                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return '-';
                }

                // Format as YYYY-MM-DD
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');

                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error('Date formatting error:', e, dateValue);
                return '-';
            }
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        /**
         * Format time duration
         */
        function formatDuration(hours, minutes) {
            const h = parseInt(hours) || 0;
            const m = parseInt(minutes) || 0;
            return h + 'h ' + m + 'm';
        }

        // Load timesheets on page load
        document.getElementById('filterStatus').value = 'Pending'; // Default to pending only
        loadTimesheets();

        // ==================== UTILITY FUNCTIONS ====================
        // These functions allow the module to work standalone (e.g., in OAuth dialogs)

        function showLoading() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'danger');
        }

        function showWarning(message) {
            showToast(message, 'warning');
        }

        function showInfo(message) {
            showToast(message, 'info');
        }

        function showToast(message, type) {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                // Fallback to alert if toast container not found
                alert(message);
                console.error('Toast container not found');
                return;
            }

            const toastId = 'toast-' + Date.now();

            const toastHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            const toastElement = document.getElementById(toastId);
            if (toastElement && typeof bootstrap !== 'undefined') {
                const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
                toast.show();

                toastElement.addEventListener('hidden.bs.toast', function() {
                    toastElement.remove();
                });
            } else {
                // Fallback for environments without Bootstrap
                setTimeout(function() {
                    if (toastElement) {
                        toastElement.remove();
                    }
                }, 5000);
            }
        }
    </script>
</body>
</html>
