<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .amount-cell { font-weight: bold; color: #28a745; }
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .batch-actions {
            background-color: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        .batch-actions.show { display: block; }
        .loan-input {
            width: 80px;
            padding: 2px 5px;
            font-size: 12px;
        }
        .loan-select {
            width: 100px;
            padding: 2px 5px;
            font-size: 12px;
        }
        .locked-row { background-color: #f5f5f5; }
        .locked-badge {
            font-size: 10px;
            background-color: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }
        .editable-badge {
            font-size: 10px;
            background-color: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }
        .btn-group-sm .btn { padding: 0.25rem 0.4rem; }
        .table th { white-space: nowrap; font-size: 13px; }
        .table td { font-size: 13px; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-dollar-sign"></i> Payslips</h5>
            <button class="btn btn-primary btn-sm" onclick="showPayrollForm()">
                <i class="fas fa-plus"></i> Create Payslip
            </button>
        </div>
        <div class="card-body">
            <!-- Filter Section -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="searchEmployee"
                               placeholder="Search by employee..." onkeyup="filterPayslips()">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterEmployer" onchange="filterPayslips()">
                            <option value="">All Employers</option>
                            <option value="SA Grinding Wheels">SA Grinding Wheels</option>
                            <option value="Scorpio Abrasives">Scorpio Abrasives</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="filterStartDate"
                               placeholder="From date" onchange="filterPayslips()">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="filterEndDate"
                               placeholder="To date" onchange="filterPayslips()">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Batch Actions Bar -->
            <div id="batchActions" class="batch-actions">
                <div class="d-flex justify-content-between align-items-center">
                    <span><strong id="selectedCount">0</strong> payslips selected</span>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="generateBatchPDFs()">
                            <i class="fas fa-file-pdf"></i> Generate PDFs
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="printBatchPDFs()">
                            <i class="fas fa-print"></i> Print PDFs
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                            <th>Record #</th>
                            <th>Date</th>
                            <th>Employee</th>
                            <th>Employer</th>
                            <th>Week Ending</th>
                            <th>Gross Pay</th>
                            <th>Deductions</th>
                            <th>Net Pay</th>
                            <th>Loan Balance</th>
                            <th>Loan Payment</th>
                            <th>Payment Type</th>
                            <th>Paid to Account</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payslipsTableBody">
                        <tr><td colspan="14" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Summary Row -->
            <div id="summaryRow" class="alert alert-info mt-3" style="display: none;">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Total Payslips:</strong> <span id="totalCount">0</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Total Gross:</strong> <span id="totalGross">R0.00</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Total Net:</strong> <span id="totalNet">R0.00</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Total Paid:</strong> <span id="totalPaid">R0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== UTILITY FUNCTIONS (GLOBAL SCOPE - MUST BE FIRST) =====
        // These MUST be in global scope for inline event handlers to work

        function formatCurrency(amount) {
            if (amount === null || amount === undefined || amount === '') {
                return 'R0.00';
            }
            return 'R' + parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Helper to extract loan balance from various formats
        function extractLoanBalance(value) {
            if (value === null || value === undefined || value === '') {
                return 0;
            }
            // If it's already a number, return it
            if (typeof value === 'number') {
                return value;
            }
            // Convert to string and check if it's the object format
            const strValue = String(value);
            // Handle format like "{success=true, data=500.0}"
            const dataMatch = strValue.match(/data[=:]\s*([0-9.]+)/);
            if (dataMatch) {
                return parseFloat(dataMatch[1]) || 0;
            }
            // Try parsing as regular number
            return parseFloat(strValue) || 0;
        }

        // Get the loan payment amount based on payment type
        function getLoanPaymentAmount(payslip) {
            const paymentType = payslip.LoanDisbursementType || 'Separate';
            if (paymentType === 'Repayment') {
                // For repayments, show LoanDeductionThisWeek
                return parseFloat(payslip.LoanDeductionThisWeek) || 0;
            } else {
                // For With Salary or Separate, show NewLoanThisWeek
                return parseFloat(payslip.NewLoanThisWeek) || 0;
            }
        }

        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function showLoading() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'danger');
        }

        function showInfo(message) {
            showToast(message, 'info');
        }

        function showToast(message, type) {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                // Fallback to alert if toast container not found
                alert(message);
                return;
            }

            const toastId = 'toast-' + Date.now();

            const toastHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            const toastElement = document.getElementById(toastId);
            if (toastElement && typeof bootstrap !== 'undefined') {
                const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
                toast.show();

                toastElement.addEventListener('hidden.bs.toast', function() {
                    toastElement.remove();
                });
            }
        }

        // ===== MODULE CODE =====
        // Wrap in IIFE to prevent re-declaration errors on module reload
        (function() {
            // Initialize data storage on window
            window.payrollListData = window.payrollListData || {};
            window.payrollListData.allPayslips = [];

            window.loadPayslips = function() {
                showLoading();
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        // Defensive null check
                        if (!result) {
                            console.error('loadPayslips received null result');
                            showError('Failed to load payslips: Server returned null');
                            return;
                        }
                        if (result.success) {
                            window.payrollListData.allPayslips = result.data;
                            filterPayslips();
                        } else {
                            showError('Failed to load payslips: ' + (result.error || 'Unknown error'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('Error: ' + error.message);
                    })
                    .listPayslips({});
            };

            window.displayPayslips = function(payslips) {
            const tbody = document.getElementById('payslipsTableBody');

            if (payslips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center">No payslips found</td></tr>';
                document.getElementById('summaryRow').style.display = 'none';
                updateBatchActions();
                return;
            }

            // Calculate totals
            let totalGross = 0, totalDeductions = 0, totalNet = 0, totalPaid = 0;

            tbody.innerHTML = payslips.map(p => {
                totalGross += p.GROSSSALARY || 0;
                totalDeductions += p.TOTALDEDUCTIONS || 0;
                totalNet += p.NETTSALARY || 0;
                totalPaid += p.PaidtoAccount || 0;

                // Check if payslip is editable (before end of Friday)
                const isEditable = checkPayslipEditable(p.WEEKENDING);
                const rowClass = isEditable ? '' : 'locked-row';
                const statusBadge = isEditable
                    ? '<span class="editable-badge">Editable</span>'
                    : '<span class="locked-badge">Locked</span>';

                return `
                    <tr class="${rowClass}" data-record="${p.RECORDNUMBER}">
                        <td><input type="checkbox" class="payslip-checkbox" value="${p.RECORDNUMBER}" onchange="updateBatchActions()"></td>
                        <td><strong>#${p.RECORDNUMBER}</strong>${statusBadge}</td>
                        <td><small>${formatDate(p.TIMESTAMP)}</small></td>
                        <td><strong>${p['EMPLOYEE NAME'] || ''}</strong></td>
                        <td>${p.EMPLOYER || ''}</td>
                        <td>${formatDate(p.WEEKENDING)}</td>
                        <td>${formatCurrency(p.GROSSSALARY || 0)}</td>
                        <td>${formatCurrency(p.TOTALDEDUCTIONS || 0)}</td>
                        <td>${formatCurrency(p.NETTSALARY || 0)}</td>
                        <td>${formatCurrency(extractLoanBalance(p.CurrentLoanBalance))}</td>
                        <td>
                            <input type="number" class="form-control loan-input"
                                   value="${getLoanPaymentAmount(p)}"
                                   data-record="${p.RECORDNUMBER}"
                                   onchange="updateLoanPayment(${p.RECORDNUMBER}, this)"
                                   ${!isEditable ? 'disabled' : ''}>
                        </td>
                        <td>
                            <select class="form-select loan-select"
                                    data-record="${p.RECORDNUMBER}"
                                    onchange="updatePaymentType(${p.RECORDNUMBER}, this)"
                                    ${!isEditable ? 'disabled' : ''}>
                                <option value="With Salary" ${(p.LoanDisbursementType === 'With Salary') ? 'selected' : ''}>With Salary</option>
                                <option value="Separate" ${(p.LoanDisbursementType === 'Separate' || !p.LoanDisbursementType) ? 'selected' : ''}>Separate</option>
                                <option value="Repayment" ${(p.LoanDisbursementType === 'Repayment') ? 'selected' : ''}>Repayment</option>
                            </select>
                        </td>
                        <td class="amount-cell">${formatCurrency(p.PaidtoAccount || 0)}</td>
                        <td class="action-buttons">
                            ${isEditable ? `
                                <button class="btn btn-sm btn-info" onclick="editPayslip(${p.RECORDNUMBER})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePayslip(${p.RECORDNUMBER})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-secondary" disabled title="Locked">
                                    <i class="fas fa-lock"></i>
                                </button>
                            `}
                            <button class="btn btn-sm btn-success" onclick="viewPayslip(${p.RECORDNUMBER})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${p.FILELINK ? `
                                <a href="${p.FILELINK}" target="_blank" class="btn btn-sm btn-primary" title="View PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                            ` : `
                                <button class="btn btn-sm btn-warning" onclick="generatePDF(${p.RECORDNUMBER})" title="Generate PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');

            // Update summary
            document.getElementById('totalCount').textContent = payslips.length;
            document.getElementById('totalGross').textContent = formatCurrency(totalGross);
            document.getElementById('totalNet').textContent = formatCurrency(totalNet);
                document.getElementById('totalPaid').textContent = formatCurrency(totalPaid);
                document.getElementById('summaryRow').style.display = 'block';

                // Reset batch actions
                updateBatchActions();
            };

            window.filterPayslips = function() {
                const searchText = document.getElementById('searchEmployee').value.toLowerCase();
                const employer = document.getElementById('filterEmployer').value;
                const startDate = document.getElementById('filterStartDate').value;
                const endDate = document.getElementById('filterEndDate').value;

                let filtered = window.payrollListData.allPayslips.filter(p => {
                const matchesSearch = !searchText ||
                    (p['EMPLOYEE NAME'] && p['EMPLOYEE NAME'].toLowerCase().includes(searchText));

                const matchesEmployer = !employer || p.EMPLOYER === employer;

                let matchesDateRange = true;
                if (startDate || endDate) {
                    const pDate = new Date(p.WEEKENDING);
                    if (startDate) {
                        matchesDateRange = matchesDateRange && pDate >= new Date(startDate);
                    }
                    if (endDate) {
                        matchesDateRange = matchesDateRange && pDate <= new Date(endDate);
                    }
                }

                    return matchesSearch && matchesEmployer && matchesDateRange;
                });

                displayPayslips(filtered);
            };

            window.clearFilters = function() {
            document.getElementById('searchEmployee').value = '';
            document.getElementById('filterEmployer').value = '';
                document.getElementById('filterStartDate').value = '';
                document.getElementById('filterEndDate').value = '';
                filterPayslips();
            };

            window.showPayrollForm = function(recordNumber) {
                // Set/clear sessionStorage BEFORE loading module
                if (recordNumber) {
                    sessionStorage.setItem('editPayslipRecordNumber', recordNumber);
                } else {
                    sessionStorage.removeItem('editPayslipRecordNumber');
                }
                // Now load the module
                loadModule('payrollForm');
            };

            window.editPayslip = function(recordNumber) {
                showPayrollForm(recordNumber);
            };

            window.viewPayslip = function(recordNumber) {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    // Defensive null check
                    if (!result) {
                        console.error('viewPayslip received null result');
                        showError('Failed to load payslip: Server returned null');
                        return;
                    }
                    if (result.success) {
                        showPayslipDetails(result.data);
                    } else {
                        showError(result.error || 'Unknown error');
                    }
                })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('Error: ' + error.message);
                    })
                    .getPayslip(recordNumber);
            };

            window.showPayslipDetails = function(payslip) {
            const details = `
                <div class="modal fade" id="payslipModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Payslip #${payslip.RECORDNUMBER} - ${payslip['EMPLOYEE NAME']}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Week Ending:</strong> ${formatDate(payslip.WEEKENDING)}</p>
                                        <p><strong>Employer:</strong> ${payslip.EMPLOYER}</p>
                                        <p><strong>Status:</strong> ${payslip['EMPLOYMENT STATUS']}</p>
                                        <p><strong>Hourly Rate:</strong> ${formatCurrency(payslip.HOURLYRATE)}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Hours:</strong> ${payslip.HOURS}h ${payslip.MINUTES}m</p>
                                        <p><strong>Overtime:</strong> ${payslip.OVERTIMEHOURS}h ${payslip.OVERTIMEMINUTES}m</p>
                                        <p><strong>Standard Time:</strong> ${formatCurrency(payslip.STANDARDTIME)}</p>
                                        <p><strong>Overtime:</strong> ${formatCurrency(payslip.OVERTIME)}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Earnings</h6>
                                        <p><strong>Gross Salary:</strong> ${formatCurrency(payslip.GROSSSALARY)}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Deductions</h6>
                                        <p><strong>UIF:</strong> ${formatCurrency(payslip.UIF || 0)}</p>
                                        <p><strong>Other:</strong> ${formatCurrency(payslip['OTHER DEDUCTIONS'] || 0)}</p>
                                        <p><strong>Loan:</strong> ${formatCurrency(payslip.LoanDeductionThisWeek || 0)}</p>
                                        <p><strong>Total:</strong> ${formatCurrency(payslip.TOTALDEDUCTIONS)}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="alert alert-success">
                                    <h5>Net Salary: ${formatCurrency(payslip.NETTSALARY)}</h5>
                                    <h4>Paid to Account: ${formatCurrency(payslip.PaidtoAccount)}</h4>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="editPayslip(${payslip.RECORDNUMBER}); bootstrap.Modal.getInstance(document.getElementById('payslipModal')).hide();">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const existing = document.getElementById('payslipModal');
            if (existing) existing.remove();

                document.body.insertAdjacentHTML('beforeend', details);
                const modal = new bootstrap.Modal(document.getElementById('payslipModal'));
                modal.show();
            };

            window.generatePDF = function(recordNumber) {
            showLoading();
            showInfo('Generating PDF... This may take a moment.');

            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    // Defensive null check
                    if (!result) {
                        console.error('generatePayslipPDF received null result');
                        showError('Failed to generate PDF: Server returned null');
                        return;
                    }
                    if (result.success) {
                        showSuccess('PDF generated successfully!');
                        loadPayslips(); // Reload to show PDF link
                    } else {
                        showError('Failed to generate PDF: ' + (result.error || 'Unknown error'));
                    }
                })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('Error: ' + error.message);
                    })
                    .generatePayslipPDF(recordNumber);
            };

            // Check if payslip is editable (client-side check)
            window.checkPayslipEditable = function(weekEnding) {
                if (!weekEnding) return false;

                const weekEndingDate = new Date(weekEnding);
                const now = new Date();

                // Set to end of Friday (23:59:59)
                const editDeadline = new Date(weekEndingDate);
                editDeadline.setHours(23, 59, 59, 999);

                return now <= editDeadline;
            };

            // Toggle select all checkboxes
            window.toggleSelectAll = function() {
                const selectAll = document.getElementById('selectAll').checked;
                const checkboxes = document.querySelectorAll('.payslip-checkbox');
                checkboxes.forEach(cb => cb.checked = selectAll);
                updateBatchActions();
            };

            // Update batch actions bar visibility
            window.updateBatchActions = function() {
                const checkboxes = document.querySelectorAll('.payslip-checkbox:checked');
                const batchActions = document.getElementById('batchActions');
                const selectedCount = document.getElementById('selectedCount');

                if (checkboxes.length > 0) {
                    batchActions.classList.add('show');
                    selectedCount.textContent = checkboxes.length;
                } else {
                    batchActions.classList.remove('show');
                }
            };

            // Get selected record numbers
            window.getSelectedRecordNumbers = function() {
                const checkboxes = document.querySelectorAll('.payslip-checkbox:checked');
                return Array.from(checkboxes).map(cb => parseInt(cb.value));
            };

            // Generate PDFs for selected payslips
            window.generateBatchPDFs = function() {
                const recordNumbers = getSelectedRecordNumbers();

                if (recordNumbers.length === 0) {
                    showError('No payslips selected');
                    return;
                }

                if (!confirm(`Generate PDFs for ${recordNumbers.length} payslip(s)?`)) {
                    return;
                }

                showLoading();
                showInfo(`Generating ${recordNumbers.length} PDFs... This may take a while.`);

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (!result) {
                            showError('Failed to generate PDFs: Server returned null');
                            return;
                        }
                        if (result.success !== false) {
                            showSuccess(`PDFs generated: ${result.succeeded}/${result.total} succeeded`);
                            if (result.failed > 0) {
                                showError(`${result.failed} PDFs failed to generate`);
                            }
                            loadPayslips(); // Reload to show PDF links
                        } else {
                            showError('Failed to generate PDFs: ' + (result.error || 'Unknown error'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('Error: ' + error.message);
                    })
                    .generateBatchPayslipPDFs(recordNumbers);
            };

            // Print batch PDFs (generate combined PDF with all selected payslips)
            window.printBatchPDFs = function() {
                const recordNumbers = getSelectedRecordNumbers();

                if (recordNumbers.length === 0) {
                    showError('No payslips selected');
                    return;
                }

                if (!confirm(`Generate combined PDF with ${recordNumbers.length} payslip(s) for printing?`)) {
                    return;
                }

                showLoading();
                showInfo(`Creating combined PDF with ${recordNumbers.length} payslips...`);

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (!result) {
                            showError('Failed to generate combined PDF: Server returned null');
                            return;
                        }
                        if (result.success) {
                            showSuccess(`Combined PDF created with ${result.data.count} payslips`);
                            // Open the PDF in a new tab for printing
                            window.open(result.data.url, '_blank');
                        } else {
                            showError('Failed to generate PDF: ' + (result.error || 'Unknown error'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('Error: ' + error.message);
                    })
                    .generateCombinedPayslipPDF(recordNumbers);
            };

            // Delete a payslip
            window.deletePayslip = function(recordNumber) {
                if (!confirm(`Are you sure you want to delete payslip #${recordNumber}?\n\nThis action cannot be undone.`)) {
                    return;
                }

                showLoading();

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (!result) {
                            showError('Failed to delete payslip: Server returned null');
                            return;
                        }
                        if (result.success) {
                            showSuccess('Payslip deleted successfully');
                            loadPayslips(); // Reload list
                        } else {
                            showError('Failed to delete payslip: ' + (result.error || 'Unknown error'));
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('Error: ' + error.message);
                    })
                    .deletePayslip(recordNumber);
            };

            // Update loan payment inline
            window.updateLoanPayment = function(recordNumber, inputElement) {
                const loanPayment = parseFloat(inputElement.value) || 0;

                showLoading();

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (!result) {
                            showError('Failed to update loan payment: Server returned null');
                            return;
                        }
                        if (result.success) {
                            showSuccess('Loan payment updated');
                            // Update the Paid to Account value in the row
                            const row = document.querySelector(`tr[data-record="${recordNumber}"]`);
                            if (row && result.data) {
                                const paidCell = row.querySelector('.amount-cell');
                                if (paidCell) {
                                    paidCell.textContent = formatCurrency(result.data.PaidtoAccount || 0);
                                }
                            }
                        } else {
                            showError('Failed to update: ' + (result.error || 'Unknown error'));
                            loadPayslips(); // Reload to reset values
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('Error: ' + error.message);
                        loadPayslips(); // Reload to reset values
                    })
                    .updatePayslipLoanPayment(recordNumber, { loanPayment: loanPayment });
            };

            // Update payment type inline
            window.updatePaymentType = function(recordNumber, selectElement) {
                const paymentType = selectElement.value;

                showLoading();

                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (!result) {
                            showError('Failed to update payment type: Server returned null');
                            return;
                        }
                        if (result.success) {
                            showSuccess('Payment type updated');
                            // Update the Paid to Account value in the row
                            const row = document.querySelector(`tr[data-record="${recordNumber}"]`);
                            if (row && result.data) {
                                const paidCell = row.querySelector('.amount-cell');
                                if (paidCell) {
                                    paidCell.textContent = formatCurrency(result.data.PaidtoAccount || 0);
                                }
                                // Also update the loan payment input to show correct value for new type
                                const loanInput = row.querySelector('.loan-input');
                                if (loanInput) {
                                    loanInput.value = getLoanPaymentAmount(result.data);
                                }
                            }
                        } else {
                            showError('Failed to update: ' + (result.error || 'Unknown error'));
                            loadPayslips(); // Reload to reset values
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('Error: ' + error.message);
                        loadPayslips(); // Reload to reset values
                    })
                    .updatePayslipLoanPayment(recordNumber, { paymentType: paymentType });
            };

            // Load payslips on page load
            loadPayslips();
        })();
    </script>
</body>
</html>
