<!-- Employee List View -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="fas fa-users"></i> Employee Management</h5>
    <button class="btn btn-primary btn-sm" onclick="showAddEmployeeForm()">
      <i class="fas fa-plus"></i> Add Employee
    </button>
  </div>
  <div class="card-body">
    <!-- Search and Filter Bar -->
    <div class="row mb-3">
      <div class="col-md-4">
        <input type="text" class="form-control" id="searchInput" placeholder="Search by name..." onkeyup="searchEmployees()">
      </div>
      <div class="col-md-3">
        <select class="form-control" id="employerFilter" onchange="applyFilters()">
          <option value="">All Employers</option>
          <option value="SA Grinding Wheels">SA Grinding Wheels</option>
          <option value="Scorpio Abrasives">Scorpio Abrasives</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-control" id="statusFilter" onchange="applyFilters()">
          <option value="">All Status</option>
          <option value="Permanent">Permanent</option>
          <option value="Temporary">Temporary</option>
          <option value="Resigned">Resigned</option>
          <option value="Dismissed">Dismissed</option>
          <option value="Absconded">Absconded</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-secondary w-100" onclick="resetFilters()">
          <i class="fas fa-undo"></i> Reset
        </button>
      </div>
    </div>

    <!-- Employee Count and Pagination Controls -->
    <div class="mb-2 d-flex justify-content-between align-items-center">
      <span id="employeeCount" class="text-muted">Loading employees...</span>
      <div id="paginationControls" class="btn-group" style="display: none;">
        <button class="btn btn-sm btn-outline-secondary" id="prevPageBtn" onclick="previousPage()">
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span class="btn btn-sm btn-outline-secondary disabled" id="pageInfo">Page 1</span>
        <button class="btn btn-sm btn-outline-secondary" id="nextPageBtn" onclick="nextPage()">
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Employee Table -->
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Name</th>
            <th>Employer</th>
            <th>Hourly Rate</th>
            <th>Status</th>
            <th>Clock #</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="employeeTableBody">
          <tr>
            <td colspan="6" class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Store all employees for client-side filtering
  var allEmployees = [];
  var searchTimeout = null;
  var currentPage = 1;
  var currentPagination = null;

  /**
   * Initialize when the module loads
   */
  function initializeEmployeeList() {
    console.log('Initializing Employee List');
    loadEmployees();
  }

  /**
   * Load employees from server
   */
  function loadEmployees(page) {
    console.log('Loading employees...');

    // Use provided page or current page
    if (page !== undefined) {
      currentPage = page;
    }

    var filters = {
      employer: document.getElementById('employerFilter')?.value || '',
      status: document.getElementById('statusFilter')?.value || '',
      search: document.getElementById('searchInput')?.value || '',
      page: currentPage,
      pageSize: 50
    };
    
    // Show loading state
    var tbody = document.getElementById('employeeTableBody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>';
    }
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Server response:', result);

        // Handle different response formats
        var employees = [];
        var pagination = null;

        if (result && result.success && result.data) {
          // Check if data has pagination format
          if (result.data.employees && Array.isArray(result.data.employees)) {
            // New paginated format: {success: true, data: {employees: [...], pagination: {...}}}
            employees = result.data.employees;
            pagination = result.data.pagination;
          } else if (Array.isArray(result.data)) {
            // Old array format: {success: true, data: [...]}
            employees = result.data;
          } else {
            console.error('Unexpected data format:', result.data);
            displayError('Unexpected response format');
            return;
          }
        } else if (Array.isArray(result)) {
          // Direct array format
          employees = result;
        } else if (result && result.success === false) {
          // Error response
          displayError(result.error || 'Failed to load employees');
          return;
        } else {
          // Unexpected format
          console.error('Unexpected response format:', result);
          displayError('Unexpected response format');
          return;
        }

        displayEmployees(employees, pagination);
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load employees:', error);
        displayError('Error loading employees: ' + (error.message || error));
      })
      .listEmployees(filters, SESSION_TOKEN);
  }

  /**
   * Display employees in table
   */
  function displayEmployees(employees, pagination) {
    console.log('Displaying', employees.length, 'employees');
    allEmployees = employees;
    currentPagination = pagination;

    var tbody = document.getElementById('employeeTableBody');
    if (!tbody) {
      console.error('Table body element not found');
      return;
    }

    tbody.innerHTML = '';

    if (!employees || employees.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No employees found</td></tr>';
      updateEmployeeCount(0, pagination);
      return;
    }

    for (var i = 0; i < employees.length; i++) {
      var emp = employees[i];
      var row = document.createElement('tr');

      // Name
      var nameCell = document.createElement('td');
      nameCell.innerHTML = '<strong>' + escapeHtml(emp.REFNAME || emp.refname || '') + '</strong>';
      row.appendChild(nameCell);

      // Employer
      var employerCell = document.createElement('td');
      employerCell.textContent = emp.EMPLOYER || emp.employer || '';
      row.appendChild(employerCell);

      // Hourly Rate
      var rateCell = document.createElement('td');
      var rate = emp['HOURLY RATE'] || emp.hourlyRate || 0;
      rateCell.textContent = 'R' + parseFloat(rate).toFixed(2);
      row.appendChild(rateCell);

      // Status
      var statusCell = document.createElement('td');
      var statusBadge = document.createElement('span');
      var status = emp['EMPLOYMENT STATUS'] || emp.employmentStatus || '';
      statusBadge.className = 'badge ' + getStatusBadgeClass(status);
      statusBadge.textContent = status;
      statusCell.appendChild(statusBadge);
      row.appendChild(statusCell);

      // Clock Number
      var clockCell = document.createElement('td');
      clockCell.textContent = emp.ClockInRef || emp.clockInRef || '';
      row.appendChild(clockCell);

      // Actions
      var actionsCell = document.createElement('td');
      var empId = emp.id || emp.ID || '';
      actionsCell.innerHTML =
        '<button class="btn btn-sm btn-info me-1" onclick="viewEmployee(\'' + empId + '\')">View</button>' +
        '<button class="btn btn-sm btn-warning" onclick="editEmployee(\'' + empId + '\')">Edit</button>';
      row.appendChild(actionsCell);

      tbody.appendChild(row);
    }

    updateEmployeeCount(employees.length, pagination);
  }

  /**
   * Display error message
   */
  function displayError(message) {
    var tbody = document.getElementById('employeeTableBody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error: ' + escapeHtml(message) + '</td></tr>';
    }
    updateEmployeeCount(0);
  }

  /**
   * Update employee count display
   */
  function updateEmployeeCount(count, pagination) {
    var countElement = document.getElementById('employeeCount');
    var paginationControls = document.getElementById('paginationControls');
    var prevBtn = document.getElementById('prevPageBtn');
    var nextBtn = document.getElementById('nextPageBtn');
    var pageInfo = document.getElementById('pageInfo');

    if (countElement) {
      if (count === 0) {
        countElement.textContent = 'No employees';
      } else if (pagination && pagination.total) {
        // Show pagination info
        var start = ((pagination.page - 1) * pagination.pageSize) + 1;
        var end = Math.min(start + count - 1, pagination.total);
        countElement.textContent = 'Showing ' + start + '-' + end + ' of ' + pagination.total + ' employees';
      } else if (count === 1) {
        countElement.textContent = 'Showing 1 employee';
      } else {
        countElement.textContent = 'Showing ' + count + ' employees';
      }
    }

    // Show/hide pagination controls
    if (pagination && pagination.totalPages > 1) {
      if (paginationControls) paginationControls.style.display = '';
      if (pageInfo) pageInfo.textContent = 'Page ' + pagination.page + ' of ' + pagination.totalPages;

      // Enable/disable buttons based on current page
      if (prevBtn) {
        if (pagination.page <= 1) {
          prevBtn.disabled = true;
          prevBtn.classList.add('disabled');
        } else {
          prevBtn.disabled = false;
          prevBtn.classList.remove('disabled');
        }
      }

      if (nextBtn) {
        if (pagination.page >= pagination.totalPages) {
          nextBtn.disabled = true;
          nextBtn.classList.add('disabled');
        } else {
          nextBtn.disabled = false;
          nextBtn.classList.remove('disabled');
        }
      }
    } else {
      // Hide pagination if only 1 page
      if (paginationControls) paginationControls.style.display = 'none';
    }
  }

  /**
   * Search employees (client-side)
   */
  function searchEmployees() {
    // Clear previous timeout
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Debounce search
    searchTimeout = setTimeout(function() {
      applyFilters();
    }, 300);
  }

  /**
   * Apply filters
   */
  function applyFilters() {
    currentPage = 1; // Reset to first page when filters change
    loadEmployees();
  }

  /**
   * Reset all filters
   */
  function resetFilters() {
    var searchInput = document.getElementById('searchInput');
    var employerFilter = document.getElementById('employerFilter');
    var statusFilter = document.getElementById('statusFilter');

    if (searchInput) searchInput.value = '';
    if (employerFilter) employerFilter.value = '';
    if (statusFilter) statusFilter.value = '';

    currentPage = 1;
    loadEmployees();
  }

  /**
   * Go to previous page
   */
  function previousPage() {
    if (currentPagination && currentPage > 1) {
      loadEmployees(currentPage - 1);
    }
  }

  /**
   * Go to next page
   */
  function nextPage() {
    if (currentPagination && currentPage < currentPagination.totalPages) {
      loadEmployees(currentPage + 1);
    }
  }

  /**
   * Show add employee form
   */
  function showAddEmployeeForm() {
    // This would typically load the employee form
    // For now, show an alert
    if (typeof loadModule === 'function') {
      loadModule('employee-form');
    } else {
      alert('Add Employee form will be loaded here');
    }
  }

  /**
   * View employee details
   */
  function viewEmployee(id) {
    console.log('View employee:', id);
    // Load employee view
    if (typeof loadModule === 'function') {
      loadModule('employee-view', {id: id});
    } else {
      alert('View employee: ' + id);
    }
  }

  /**
   * Edit employee
   */
  function editEmployee(id) {
    console.log('Edit employee:', id);
    // Load employee edit form
    if (typeof loadModule === 'function') {
      loadModule('employee-edit', {id: id});
    } else {
      alert('Edit employee: ' + id);
    }
  }

  /**
   * Get badge class for employment status
   */
  function getStatusBadgeClass(status) {
    switch(status) {
      case 'Permanent':
        return 'bg-success';
      case 'Temporary':
        return 'bg-warning';
      case 'Resigned':
      case 'Dismissed':
      case 'Absconded':
        return 'bg-danger';
      default:
        return 'bg-secondary';
    }
  }

  /**
   * Escape HTML to prevent XSS
   */
  function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text.toString();
    return div.innerHTML;
  }

  // Initialize on load
  // Check if we're being loaded dynamically or statically
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEmployeeList);
  } else {
    // DOM is already loaded (dynamic loading)
    initializeEmployeeList();
  }
</script>
