<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .badge-disbursement { background-color: #dc3545; }
        .badge-repayment { background-color: #28a745; }
        .amount-positive { color: #dc3545; font-weight: bold; }
        .amount-negative { color: #28a745; font-weight: bold; }
        .balance-display {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-money-bill-wave"></i> Loan Transactions</h5>
            <button class="btn btn-primary btn-sm" onclick="showLoanForm()">
                <i class="fas fa-plus"></i> Add Transaction
            </button>
        </div>
        <div class="card-body">
            <!-- Filter Section -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-5">
                        <label>Employee</label>
                        <select class="form-select" id="filterEmployee" onchange="filterLoans()">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Start Date</label>
                        <input type="date" class="form-control" id="filterStartDate" onchange="filterLoans()">
                    </div>
                    <div class="col-md-3">
                        <label>End Date</label>
                        <input type="date" class="form-control" id="filterEndDate" onchange="filterLoans()">
                    </div>
                    <div class="col-md-1">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Current Balance Display (when employee selected) -->
            <div id="balanceDisplay" style="display: none;" class="balance-display">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-0">
                            <i class="fas fa-user"></i> <span id="selectedEmployeeName"></span>
                        </h6>
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Current Balance:</strong>
                        <span id="currentBalance" class="fs-5"></span>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Employee</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Mode</th>
                            <th>Balance After</th>
                            <th>Payslip #</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="loansTableBody">
                        <tr><td colspan="8" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Store all loan-related data
        var loanListData = {
            allEmployees: [],
            selectedEmployeeId: null
        };

        /**
         * Initialize the loan list module
         */
        function initializeLoanList() {
            console.log('üöÄ ===== LOAN LIST MODULE INITIALIZING =====');
            console.log('DOM readyState:', document.readyState);
            console.log('Current time:', new Date().toISOString());

            var tbody = document.getElementById('loansTableBody');
            console.log('loansTableBody element:', tbody ? 'FOUND' : 'NOT FOUND');

            loadEmployees();

            // Show initial message
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-info-circle"></i> Please select an employee to view loan transactions</td></tr>';
                console.log('‚úì Initial message set');
            } else {
                console.error('‚ùå Cannot set initial message - tbody not found');
            }

            console.log('===== LOAN LIST MODULE INITIALIZED =====');
        }

        function loadEmployees() {
            console.log('üìû Calling listEmployees()...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('‚úÖ listEmployees() response:', result);
                    console.log('Response type:', typeof result);
                    console.log('Is array?', Array.isArray(result));

                    if (result && result.success && result.data) {
                        console.log('‚úì Using result.data format, employees:', result.data.length);
                        loanListData.allEmployees = result.data;
                        const select = document.getElementById('filterEmployee');
                        if (select) {
                            select.innerHTML = '<option value="">All Employees</option>' +
                                result.data.map(emp =>
                                    `<option value="${emp.id}">${emp.REFNAME}</option>`
                                ).join('');
                            console.log('‚úì Employee dropdown populated with', result.data.length, 'employees');
                        } else {
                            console.error('‚ùå filterEmployee element not found!');
                        }
                    } else if (result && Array.isArray(result)) {
                        console.log('‚úì Using direct array format, employees:', result.length);
                        loanListData.allEmployees = result;
                        const select = document.getElementById('filterEmployee');
                        if (select) {
                            select.innerHTML = '<option value="">All Employees</option>' +
                                result.map(emp =>
                                    `<option value="${emp.id}">${emp.REFNAME}</option>`
                                ).join('');
                            console.log('‚úì Employee dropdown populated with', result.length, 'employees');
                        } else {
                            console.error('‚ùå filterEmployee element not found!');
                        }
                    } else {
                        console.error('‚ùå Unexpected response format from listEmployees:', result);
                        if (typeof showError === 'function') {
                            showError('Failed to load employees');
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Failed to load employees:', error);
                    if (typeof showError === 'function') {
                        showError('Error loading employees: ' + error.message);
                    }
                })
                .listEmployees({});
        }

        function loadLoans() {
            console.log('üîÑ loadLoans() called');

            if (typeof showLoading === 'function') {
                showLoading();
            }

            const employeeId = document.getElementById('filterEmployee').value;
            const startDate = document.getElementById('filterStartDate').value || null;
            const endDate = document.getElementById('filterEndDate').value || null;

            console.log('Filter values:', {employeeId, startDate, endDate});

            if (employeeId) {
                console.log('‚úì Employee selected, loading loan history');
                loanListData.selectedEmployeeId = employeeId;
                // Load balance and history for specific employee
                loadEmployeeLoanHistory(employeeId, startDate, endDate);
            } else {
                console.log('‚ö†Ô∏è No employee selected, showing message');
                loanListData.selectedEmployeeId = null;
                var balanceDisplay = document.getElementById('balanceDisplay');
                if (balanceDisplay) {
                    balanceDisplay.style.display = 'none';
                }
                // Show message that employee must be selected
                var tbody = document.getElementById('loansTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-info-circle"></i> Please select an employee to view loan transactions</td></tr>';
                    console.log('‚úì Initial message shown');
                } else {
                    console.error('‚ùå loansTableBody element not found!');
                }
                if (typeof hideLoading === 'function') {
                    hideLoading();
                }
            }
        }

        function loadEmployeeLoanHistory(employeeId, startDate, endDate) {
            console.log('üîç loadEmployeeLoanHistory called with:', {employeeId, startDate, endDate});

            // Get employee name
            const employee = loanListData.allEmployees.find(emp => emp.id === employeeId);
            const employeeName = employee ? employee.REFNAME : 'Unknown';
            console.log('Employee found:', employeeName);

            // Load current balance
            console.log('üìû Calling getCurrentLoanBalance(' + employeeId + ')...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('‚úÖ getCurrentLoanBalance() response:', result);

                    var empNameElem = document.getElementById('selectedEmployeeName');
                    var balanceElem = document.getElementById('currentBalance');
                    var balanceDisplay = document.getElementById('balanceDisplay');

                    if (empNameElem) empNameElem.textContent = employeeName;

                    if (result && result.success) {
                        const balance = result.data || 0;
                        console.log('‚úì Balance loaded:', balance);
                        if (balanceElem) balanceElem.textContent = formatCurrency(balance);
                        if (balanceDisplay) balanceDisplay.style.display = 'block';
                    } else {
                        console.warn('‚ö†Ô∏è Balance result not successful, using 0');
                        if (balanceElem) balanceElem.textContent = formatCurrency(0);
                        if (balanceDisplay) balanceDisplay.style.display = 'block';
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Failed to load balance:', error);
                    var empNameElem = document.getElementById('selectedEmployeeName');
                    var balanceElem = document.getElementById('currentBalance');
                    var balanceDisplay = document.getElementById('balanceDisplay');

                    if (empNameElem) empNameElem.textContent = employeeName;
                    if (balanceElem) balanceElem.textContent = 'Error';
                    if (balanceDisplay) balanceDisplay.style.display = 'block';
                })
                .getCurrentLoanBalance(employeeId);

            // Load transaction history
            console.log('üìû Calling getLoanHistory(' + employeeId + ', ' + startDate + ', ' + endDate + ')...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('‚úÖ getLoanHistory() response:', result);
                    console.log('Response type:', typeof result);

                    if (typeof hideLoading === 'function') {
                        hideLoading();
                    }

                    if (result && result.success) {
                        console.log('‚úì Loan history success, records:', result.data ? result.data.length : 0);
                        if (result.data && result.data.length > 0) {
                            console.log('First loan record:', result.data[0]);
                        }
                        displayLoans(result.data || []);
                    } else {
                        const errorMsg = result && result.error ? result.error : 'Unknown error';
                        console.error('‚ùå Loan history failed:', errorMsg);
                        if (typeof showError === 'function') {
                            showError('Failed to load loan history: ' + errorMsg);
                        }
                        displayLoans([]);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå getLoanHistory() failed:', error);
                    if (typeof hideLoading === 'function') {
                        hideLoading();
                    }
                    if (typeof showError === 'function') {
                        showError('Error: ' + error.message);
                    }
                    displayLoans([]);
                })
                .getLoanHistory(employeeId, startDate, endDate);
        }

        function displayLoans(loans) {
            console.log('üìä displayLoans called with', loans ? loans.length : 0, 'loans');

            const tbody = document.getElementById('loansTableBody');
            if (!tbody) {
                console.error('‚ùå Loan table body element not found!');
                return;
            }

            if (!loans || loans.length === 0) {
                console.log('‚ö†Ô∏è No loans to display');
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No loan transactions found</td></tr>';
                return;
            }

            console.log('‚úì Rendering', loans.length, 'loan transactions');
            console.log('Sample loan data:', loans[0]);

            try {
                tbody.innerHTML = loans.map((loan, index) => {
                    const typeClass = loan.LoanType === 'Disbursement' ? 'badge-disbursement' : 'badge-repayment';
                    const amountClass = loan.LoanAmount > 0 ? 'amount-positive' : 'amount-negative';

                    return `
                        <tr>
                            <td>${formatDate(loan.TransactionDate)}</td>
                            <td><strong>${loan['Employee Name'] || ''}</strong></td>
                            <td><span class="badge ${typeClass}">${loan.LoanType}</span></td>
                            <td class="${amountClass}">${formatCurrency(loan.LoanAmount)}</td>
                            <td><small>${loan.DisbursementMode}</small></td>
                            <td><strong>${formatCurrency(loan.BalanceAfter)}</strong></td>
                            <td>${loan.SalaryLink || '-'}</td>
                            <td><small>${loan.Notes || '-'}</small></td>
                        </tr>
                    `;
                }).join('');
                console.log('‚úÖ Loans rendered successfully');
            } catch (error) {
                console.error('‚ùå Error rendering loans:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error displaying loans</td></tr>';
            }
        }

        function filterLoans() {
            loadLoans();
        }

        function clearFilters() {
            var empFilter = document.getElementById('filterEmployee');
            var startDate = document.getElementById('filterStartDate');
            var endDate = document.getElementById('filterEndDate');
            var balanceDisplay = document.getElementById('balanceDisplay');
            var tbody = document.getElementById('loansTableBody');

            if (empFilter) empFilter.value = '';
            if (startDate) startDate.value = '';
            if (endDate) endDate.value = '';
            if (balanceDisplay) balanceDisplay.style.display = 'none';
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-info-circle"></i> Please select an employee to view loan transactions</td></tr>';
            }
        }

        function showLoanForm() {
            if (typeof loadModule === 'function') {
                loadModule('loanForm');
            }
        }

        // Helper function to format currency
        function formatCurrency(amount) {
            if (amount === null || amount === undefined || amount === '') {
                return 'R0.00';
            }
            return 'R' + parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Helper function to format date
        function formatDate(date) {
            if (!date) return '';
            try {
                // Handle ISO string dates
                const d = new Date(date);
                if (isNaN(d.getTime())) return date; // Return as-is if invalid
                return d.toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' });
            } catch (error) {
                console.error('Error formatting date:', error);
                return date;
            }
        }

        // Initialize on load
        // Check if we're being loaded dynamically or statically
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLoanList);
        } else {
            // DOM is already loaded (dynamic loading)
            initializeLoanList();
        }
    </script>
</body>
</html>
