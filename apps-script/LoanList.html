<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .badge-disbursement { background-color: #dc3545; }
        .badge-repayment { background-color: #28a745; }
        .amount-positive { color: #dc3545; font-weight: bold; }
        .amount-negative { color: #28a745; font-weight: bold; }
        .balance-display {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-money-bill-wave"></i> Loan Transactions</h5>
            <button class="btn btn-primary btn-sm" onclick="showLoanForm()">
                <i class="fas fa-plus"></i> Add Transaction
            </button>
        </div>
        <div class="card-body">
            <!-- Filter Section -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-5">
                        <label>Employee</label>
                        <select class="form-select" id="filterEmployee" onchange="filterLoans()">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Start Date</label>
                        <input type="date" class="form-control" id="filterStartDate" onchange="filterLoans()">
                    </div>
                    <div class="col-md-3">
                        <label>End Date</label>
                        <input type="date" class="form-control" id="filterEndDate" onchange="filterLoans()">
                    </div>
                    <div class="col-md-1">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Current Balance Display (when employee selected) -->
            <div id="balanceDisplay" style="display: none;" class="balance-display">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-0">
                            <i class="fas fa-user"></i> <span id="selectedEmployeeName"></span>
                        </h6>
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Current Balance:</strong>
                        <span id="currentBalance" class="fs-5"></span>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Employee</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Mode</th>
                            <th>Balance After</th>
                            <th>Payslip #</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="loansTableBody">
                        <tr><td colspan="8" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Store all loan-related data
        var loanListData = {
            allEmployees: [],
            selectedEmployeeId: null
        };

        /**
         * Initialize the loan list module
         */
        function initializeLoanList() {
            console.log('Initializing Loan List');
            loadEmployees();
            // Show initial message
            var tbody = document.getElementById('loansTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-info-circle"></i> Please select an employee to view loan transactions</td></tr>';
            }
        }

        function loadEmployees() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result && result.success && result.data) {
                        loanListData.allEmployees = result.data;
                        const select = document.getElementById('filterEmployee');
                        if (select) {
                            select.innerHTML = '<option value="">All Employees</option>' +
                                result.data.map(emp =>
                                    `<option value="${emp.id}">${emp.REFNAME}</option>`
                                ).join('');
                        }
                    } else if (result && Array.isArray(result)) {
                        // Handle case where listEmployees returns array directly
                        loanListData.allEmployees = result;
                        const select = document.getElementById('filterEmployee');
                        if (select) {
                            select.innerHTML = '<option value="">All Employees</option>' +
                                result.map(emp =>
                                    `<option value="${emp.id}">${emp.REFNAME}</option>`
                                ).join('');
                        }
                    } else {
                        console.error('Unexpected response format from listEmployees:', result);
                        if (typeof showError === 'function') {
                            showError('Failed to load employees');
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load employees:', error);
                    if (typeof showError === 'function') {
                        showError('Error loading employees: ' + error.message);
                    }
                })
                .listEmployees({});
        }

        function loadLoans() {
            if (typeof showLoading === 'function') {
                showLoading();
            }

            const employeeId = document.getElementById('filterEmployee').value;
            const startDate = document.getElementById('filterStartDate').value || null;
            const endDate = document.getElementById('filterEndDate').value || null;

            if (employeeId) {
                loanListData.selectedEmployeeId = employeeId;
                // Load balance and history for specific employee
                loadEmployeeLoanHistory(employeeId, startDate, endDate);
            } else {
                loanListData.selectedEmployeeId = null;
                var balanceDisplay = document.getElementById('balanceDisplay');
                if (balanceDisplay) {
                    balanceDisplay.style.display = 'none';
                }
                // Show message that employee must be selected
                var tbody = document.getElementById('loansTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-info-circle"></i> Please select an employee to view loan transactions</td></tr>';
                }
                if (typeof hideLoading === 'function') {
                    hideLoading();
                }
            }
        }

        function loadEmployeeLoanHistory(employeeId, startDate, endDate) {
            // Get employee name
            const employee = loanListData.allEmployees.find(emp => emp.id === employeeId);
            const employeeName = employee ? employee.REFNAME : 'Unknown';

            // Load current balance
            google.script.run
                .withSuccessHandler(function(result) {
                    var empNameElem = document.getElementById('selectedEmployeeName');
                    var balanceElem = document.getElementById('currentBalance');
                    var balanceDisplay = document.getElementById('balanceDisplay');

                    if (empNameElem) empNameElem.textContent = employeeName;

                    if (result && result.success) {
                        const balance = result.data || 0;
                        if (balanceElem) balanceElem.textContent = formatCurrency(balance);
                        if (balanceDisplay) balanceDisplay.style.display = 'block';
                    } else {
                        if (balanceElem) balanceElem.textContent = formatCurrency(0);
                        if (balanceDisplay) balanceDisplay.style.display = 'block';
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load balance:', error);
                    var empNameElem = document.getElementById('selectedEmployeeName');
                    var balanceElem = document.getElementById('currentBalance');
                    var balanceDisplay = document.getElementById('balanceDisplay');

                    if (empNameElem) empNameElem.textContent = employeeName;
                    if (balanceElem) balanceElem.textContent = 'Error';
                    if (balanceDisplay) balanceDisplay.style.display = 'block';
                })
                .getCurrentLoanBalance(employeeId);

            // Load transaction history
            google.script.run
                .withSuccessHandler(function(result) {
                    if (typeof hideLoading === 'function') {
                        hideLoading();
                    }
                    if (result && result.success) {
                        displayLoans(result.data || []);
                    } else {
                        const errorMsg = result && result.error ? result.error : 'Unknown error';
                        if (typeof showError === 'function') {
                            showError('Failed to load loan history: ' + errorMsg);
                        }
                        displayLoans([]);
                    }
                })
                .withFailureHandler(function(error) {
                    if (typeof hideLoading === 'function') {
                        hideLoading();
                    }
                    if (typeof showError === 'function') {
                        showError('Error: ' + error.message);
                    }
                    displayLoans([]);
                })
                .getLoanHistory(employeeId, startDate, endDate);
        }

        function displayLoans(loans) {
            const tbody = document.getElementById('loansTableBody');
            if (!tbody) {
                console.error('Loan table body element not found');
                return;
            }

            if (!loans || loans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No loan transactions found</td></tr>';
                return;
            }

            tbody.innerHTML = loans.map(loan => {
                const typeClass = loan.LoanType === 'Disbursement' ? 'badge-disbursement' : 'badge-repayment';
                const amountClass = loan.LoanAmount > 0 ? 'amount-positive' : 'amount-negative';

                return `
                    <tr>
                        <td>${formatDate(loan.TransactionDate)}</td>
                        <td><strong>${loan['Employee Name'] || ''}</strong></td>
                        <td><span class="badge ${typeClass}">${loan.LoanType}</span></td>
                        <td class="${amountClass}">${formatCurrency(loan.LoanAmount)}</td>
                        <td><small>${loan.DisbursementMode}</small></td>
                        <td><strong>${formatCurrency(loan.BalanceAfter)}</strong></td>
                        <td>${loan.SalaryLink || '-'}</td>
                        <td><small>${loan.Notes || '-'}</small></td>
                    </tr>
                `;
            }).join('');
        }

        function filterLoans() {
            loadLoans();
        }

        function clearFilters() {
            var empFilter = document.getElementById('filterEmployee');
            var startDate = document.getElementById('filterStartDate');
            var endDate = document.getElementById('filterEndDate');
            var balanceDisplay = document.getElementById('balanceDisplay');
            var tbody = document.getElementById('loansTableBody');

            if (empFilter) empFilter.value = '';
            if (startDate) startDate.value = '';
            if (endDate) endDate.value = '';
            if (balanceDisplay) balanceDisplay.style.display = 'none';
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-info-circle"></i> Please select an employee to view loan transactions</td></tr>';
            }
        }

        function showLoanForm() {
            if (typeof loadModule === 'function') {
                loadModule('loanForm');
            }
        }

        // Helper function to format currency
        function formatCurrency(amount) {
            if (amount === null || amount === undefined || amount === '') {
                return 'R0.00';
            }
            return 'R' + parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Helper function to format date
        function formatDate(date) {
            if (!date) return '';
            try {
                // Handle ISO string dates
                const d = new Date(date);
                if (isNaN(d.getTime())) return date; // Return as-is if invalid
                return d.toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' });
            } catch (error) {
                console.error('Error formatting date:', error);
                return date;
            }
        }

        // Initialize on load
        // Check if we're being loaded dynamically or statically
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLoanList);
        } else {
            // DOM is already loaded (dynamic loading)
            initializeLoanList();
        }
    </script>
</body>
</html>
